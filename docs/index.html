<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>HL7.FHIR.SMART-WEB-MESSAGING\Home - FHIR v4.0.1</title>
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link rel="stylesheet" href="fhir.css"/>
     
      <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.css"/>
    <link rel="stylesheet" href="assets/css/bootstrap-fhir.css"/>
  
      <!-- Project extras -->
    <link rel="stylesheet" href="assets/css/project.css"/>
    <link rel="stylesheet" href="assets/css/pygments-manni.css"/>
    <link rel="stylesheet" href="assets/css/jquery-ui.css"/>
      <!-- Placeholder for child template CSS declarations -->

    <script src="fhir-table-scripts.js" type="text/javascript"> </script>

      <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
      <!-- [if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif] -->
  
      <!-- Favicons -->
    <link sizes="144x144" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link sizes="114x114" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link sizes="72x72" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body>

    <style type="text/css">h2{--heading-prefix:"1"}
    h3,h4,h5,h6{--heading-prefix:"1"}</style>
    <div id="segment-header" class="segment">    <!-- segment-header -->
      <div class="container">    <!-- container -->
          <!-- Placeholder for child template header declarations -->


        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">SMART Web Messaging Implementation Guide: Release 1</span><br/>1.0.0 - Build CI</p>
        </div>
      </div>   <!-- /container -->
    </div>    <!-- /segment-header -->
    
    <div id="segment-navbar" class="segment">    <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">    <!-- container -->
          <!-- HEADER CONTENT -->
    
        <nav class="navbar navbar-inverse">
            <!-- status-bar -->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a href="http://hl7.org/fhir/R4/index.html" class="navbar-brand hidden">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
                <!-- menu.xml -->

<ul class="nav navbar-nav">
  <li>
    <a href="index.html">IG Home</a>
  </li>
  <li>
    <a href="toc.html">TOC</a>
  </li>
</ul>
            </div>    <!-- /.nav-collapse -->
          </div>    <!-- /.container -->
        </nav>    <!-- /.navbar -->
        <!-- /HEADER CONTENT -->
      </div>    <!-- /container -->
    </div>    <!-- /segment-navbar -->
      <!-- status-bar -->
    <div id="segment-breadcrumb" class="segment">    <!-- segment-breadcrumb -->
      <div class="container">    <!-- container -->  
        <ul class="breadcrumb">
          <li><a href="toc.html"><b>Table of Contents</b></a></li><li><b>Home</b></li>
        </ul>  
      </div>    <!-- /container -->
    </div>    <!-- /segment-breadcrumb -->
    
    <div id="segment-content" class="segment">    <!-- segment-content -->
      <div class="container">    <!-- container -->
        <div class="row">
          <div class="inner-wrapper">
<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
    <!-- ReleaseHeader --><p id="publish-box">SMART Web Messaging Implementation Guide: Release 1 - Local Development build (v1.0.0). See the <a href="http://hl7.org/fhir/smart-web-messaging/history.html">Directory of published versions</a></p>  <!-- EndReleaseHeader -->
  <h2>Home</h2>
  
  
  
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#smart-web-messaging" id="markdown-toc-smart-web-messaging">smart-web-messaging</a></li>
  <li><a href="#why" id="markdown-toc-why">Why</a></li>
  <li><a href="#smart-web-messaging-1" id="markdown-toc-smart-web-messaging-1">SMART Web Messaging</a>    <ul>
      <li><a href="#messagetype--ui-influence-ehr-ui" id="markdown-toc-messagetype--ui-influence-ehr-ui"><code class="language-plaintext highlighter-rouge">messageType == ui.*</code>: Influence EHR UI</a></li>
      <li><a href="#messagetype--scratchpad-fhir-api-interactions" id="markdown-toc-messagetype--scratchpad-fhir-api-interactions"><code class="language-plaintext highlighter-rouge">messageType == scratchpad.*</code>: FHIR API Interactions</a></li>
      <li><a href="#authorization-with-smart-scopes" id="markdown-toc-authorization-with-smart-scopes">Authorization with SMART scopes</a>        <ul>
          <li><a href="#scope-examples" id="markdown-toc-scope-examples">Scope examples</a></li>
        </ul>
      </li>
      <li><a href="#limitations" id="markdown-toc-limitations">Limitations</a></li>
      <li><a href="#alternatives-considered" id="markdown-toc-alternatives-considered">Alternatives considered</a></li>
      <li><a href="#open-questions" id="markdown-toc-open-questions">Open Questions</a></li>
    </ul>
  </li>
</ul>

</div>
  <!-- index.md -->
<h1 id="smart-web-messaging">smart-web-messaging</h1>
<p>SMART Web Messaging enables tight UI integration between EHRs and embedded SMART apps via HTML5’s Web Messaging. Use SMART Web Messaging to push unsigned orders, note snippets, risk scores or UI suggestions directly to the clinician’s EHR session. Built  on the browser’s javascript <code class="language-plaintext highlighter-rouge">window.postMessage</code> function, SMART Web Messaging is a simple, native API for health apps embedded within the user’s workflow.</p>

<h1 id="why">Why</h1>

<p>Within a clinical workflow system (such as an EHR), SMART apps can be launched automatically at specific points in the workflow, or on demand in response to a user interaction, including clicking on a suggestion from a CDS Hooks service. Once launched, a web app is typically embedded within a patient’s chart and communicates with the EHR via RESTful FHIR APIs. These RESTful APIs are great for CRUD operations on a database, but don’t enable tight workflow integration or access to draft FHIR resources that may only exist in memory on the EHR client.</p>

<p>For these embedded apps, there are some key use cases that SMART and CDS Hooks don’t address today:</p>

<ul>
  <li>Communicate a decision made by the clinician within the SMART app, such as placing an order, annotating a procedure with a appropriateness score or radiation count, transmitting a textual note snippet or suggesting a diagnosis or condition to the patient’s chart.</li>
  <li>Interrogate the orders scratchpad / shopping cart, currently only known within the ordering provider’s CPOE session.</li>
  <li>Allow an app to communicate UX-relevant results back to the EHR, for example, navigate to a native EHR activity, or an “I’m done signal”.</li>
</ul>

<p>Additionally, there are interesting capabilities enabled by tighter integration, for example:</p>
<ul>
  <li>Save an app specific session or state identifier to the EHR for later retrieval.</li>
  <li>Interact with the EHR’s FHIR server directly through this messaging channel (rather than through the REST API, thereby keeping the FHIR server off of the internet).</li>
</ul>

<h1 id="smart-web-messaging-1">SMART Web Messaging</h1>

<p>SMART Messaging builds on HTML 5’s <a href="https://www.w3.org/TR/webmessaging">Web Messaging</a>, which allows web pages to communicate across domains. Javascript’s <code class="language-plaintext highlighter-rouge">window.postMessage</code> API passes <code class="language-plaintext highlighter-rouge">MessageEvent</code> objects between windows.</p>

<p>A <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage"><code class="language-plaintext highlighter-rouge">postMessage</code>-based messaging</a> allows flexible, standards-based integration that works across windows, frames and domains, and should be readily supportable in browser controls for thin or thick-client EHRs.</p>

<p><a name="52ed2610-24c1-4fd2-9d36-2eb46e01ba6c">​</a><img src="img/web messaging launch.png" alt="SMART Web Messaging launch"/></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App needs to know EHR's origin.</span>
<span class="c1">// Add a smart_messaging_origin launch context parameter alongside the access_token</span>
<span class="c1">// to tell the app what the EHR's origin will be</span>
<span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">).</span><span class="nx">postMessage</span><span class="p">({</span>
  <span class="dl">"</span><span class="s2">authentication</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span><span class="c1">// maybe }</span>
  <span class="dl">"</span><span class="s2">messageId</span><span class="dl">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">some</span> <span class="nx">guid</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">messageType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">scratchpad.create</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">payload</span><span class="dl">"</span><span class="p">:</span> <span class="c1">// see below</span>
<span class="p">},</span> <span class="nx">targetOrigin</span><span class="p">)</span>
</code></pre></div></div>

<p>In response, EHR may send one return message like:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">appWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
  <span class="dl">"</span><span class="s2">messageId</span><span class="dl">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">some</span> <span class="k">new</span> <span class="nx">guid</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">responseToMessageId</span><span class="dl">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">original</span> <span class="nx">guid</span><span class="o">&gt;</span>
  <span class="dl">"</span><span class="s2">payload</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// as for FHIR's Bundle.entry.response</span>
    <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span><span class="p">:,</span>		<span class="c1">// HTTP response codes, for simplicity, consistency</span>
    <span class="dl">"</span><span class="s2">location</span><span class="dl">"</span><span class="p">:,</span>      <span class="c1">// could be relative for scratchpad-like stuff?</span>
    <span class="dl">"</span><span class="s2">outcome</span><span class="dl">"</span><span class="p">:,</span>       <span class="c1">// include the resource as created</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="nx">targetOrigin</span><span class="p">)</span>
</code></pre></div></div>

<p>This enables a request/response pattern; applications should be prepared to see at most one incoming message with a given <code class="language-plaintext highlighter-rouge">responseToMessageId</code>. (If message streams are needed, this can be accomplished by having the server send “unsolicited” messages, i.e., messages with no <code class="language-plaintext highlighter-rouge">responseToMessageId</code>, after a client’s initial request.)</p>

<p><strong>For subsequent code samples, we abstract away some of the messaging details via a (theoretical) simple SMART Messaging javascript library, which accepts a messageType and payload and returns a promise that resolves with the response payload.</strong></p>

<h2 id="messagetype--ui-influence-ehr-ui"><code class="language-plaintext highlighter-rouge">messageType == ui.*</code>: Influence EHR UI</h2>

<p>An embedded SMART app improves the clinician’s user experience by closing itself or requesting the EHR to navigate the user to an appropriate activity.</p>

<p><a name="d7e5a2b5-4fee-441e-a386-895e8a5f8478">​</a>All <code class="language-plaintext highlighter-rouge">ui.done</code> and <code class="language-plaintext highlighter-rouge">ui.launchActivity</code> messages may include an <code class="language-plaintext highlighter-rouge">activityType</code>
such as <code class="language-plaintext highlighter-rouge">problem-add</code> or <code class="language-plaintext highlighter-rouge">order-sign</code>. These named activity types are drawn
from the SMART Web Messaging <a href="./activity-catalog.md">Activity Catalog</a>.  In
general, these activities follow the same naming conventions as entries in the
CDS Hooks catalog, and will align with CDS Hooks catalog entries where
feasible.</p>

<p>The <code class="language-plaintext highlighter-rouge">ui.done</code> messageType instructs the EHR to close the activity hosting the SMART app, and optionally navigates the user to an alternate activity:</p>

<p><em>Note:</em> A SMART app launched in the context of CDS Hooks should generally not
need to specify an <code class="language-plaintext highlighter-rouge">activityType</code> with the <code class="language-plaintext highlighter-rouge">ui.done</code> message, because the EHR
tracks the context in which the app was launched (e.g., order entry) and can
navigate to the appropriate follow-up screen based on this context.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">SMART</span><span class="p">.</span><span class="nx">messaging</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">ui.done</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">activityType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">problem-add</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">activityParameters</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// Each ui activity defines its optional+required params</span>
    <span class="dl">"</span><span class="s2">problem</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">resourceType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Condition</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">patient</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">responsePayload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...})</span>
</code></pre></div></div>

<p>Similarly, the SMART app can use the <code class="language-plaintext highlighter-rouge">ui.LaunchActivity</code> messageType to request navigation to an alternate activity without closing the app:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">SMART</span><span class="p">.</span><span class="nx">messaging</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">ui.launchActivity</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">activityType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">problem-add</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">activityParameters</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// Each ui activity defines its optional+required params</span>
    <span class="dl">"</span><span class="s2">problem</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">resourceType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Condition</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">patient</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">responsePayload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...})</span>
</code></pre></div></div>

<p>The EHR responds to all <code class="language-plaintext highlighter-rouge">ui</code> messageTypes with a payload that includes a boolean success parameter and an optional <code class="language-plaintext highlighter-rouge">details</code> string:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span> <span class="o">|</span> <span class="kc">false</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">details</span><span class="dl">"</span><span class="p">:</span> <span class="nx">string</span> <span class="nx">explanation</span> <span class="k">for</span> <span class="nx">user</span> <span class="p">(</span><span class="nx">optionally</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="messagetype--scratchpad-fhir-api-interactions"><code class="language-plaintext highlighter-rouge">messageType == scratchpad.*</code>: FHIR API Interactions</h2>

<p>While interacting with an embedded SMART app, a clinician may make decisions that should be implemented in the EHR with minimal clicks. SMART Messaging exposes an API to the clinician’s scratchpad within the EHR, which may contain FHIR resources unavailable on the RESTful FHIR API. For example, the proposed CDS Hooks decision workflow can be implemented through SMART Messaging.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">SMART</span><span class="p">.</span><span class="nx">messaging</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span>
  <span class="c1">// "create"| "update"| "read" | "search" | "delete"</span>
  <span class="dl">"</span><span class="s2">scratchpad.[interaction-name]</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">resource</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">resourceType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ServiceRequest</span><span class="dl">"</span><span class="p">,</span> 
      <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">draft</span><span class="dl">"</span><span class="p">,</span> 
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>SMART Messaging is designed to be compatible with CDS Hooks, and to implement the CDS Hooks decisions flow. For any CDS Hooks Actions array, you can create a list of SMART.messaging API calls:</p>

<ul>
  <li>CDS Hooks suggestion type is used to populate the payload’s <code class="language-plaintext highlighter-rouge">.messageType</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">create</code> → <code class="language-plaintext highlighter-rouge">scratchpad.create</code></li>
      <li><code class="language-plaintext highlighter-rouge">update</code>→ <code class="language-plaintext highlighter-rouge">cratchpad.update</code></li>
      <li><code class="language-plaintext highlighter-rouge">delete</code>→ <code class="language-plaintext highlighter-rouge">scratchpad.delete</code></li>
    </ul>
  </li>
  <li>CDS Hooks suggestion body: used to populate the the payload’s <code class="language-plaintext highlighter-rouge">.payload.resource</code></li>
</ul>

<p>For example, a proposal to update a draft prescription in the context of a CS Hooks request might look like:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Update to a better, cheaper alternative prescription</span>
<span class="nx">SMART</span><span class="p">.</span><span class="nx">messaging</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">scratchpad.update</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">resource</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">resourceType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">MedicationRequest</span><span class="dl">"</span><span class="p">,</span> 
    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">draft</span><span class="dl">"</span> <span class="c1">// more details below</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">responsePayload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...})</span>
</code></pre></div></div>

<h2 id="authorization-with-smart-scopes">Authorization with SMART scopes</h2>

<p>SMART Messaging uses OAuth 2.0 scopes. While a simple <code class="language-plaintext highlighter-rouge">MedicationRequest.read</code> scope authorizes a SMART app to not only query for a patient’s prescriptions from the RESTful FHIR server, the same scope also authorizes an app to query the EHR’s SMART container for a list of unsigned, draft orders that only exist in the memory of the EHR client.
SMART Messaging enables capabilities outside of simple FHIR CRUD operations and are treated simply as additional scopes within the newly introduced SMART <code class="language-plaintext highlighter-rouge">messaging</code> scope category. For example, a SMART app could read the patient’s prescribed medications, the list of not yet prescribed medications and also launch the native problem-list activity by requesting the following scopes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">­patient/MedicationRequest.read</code></li>
  <li><code class="language-plaintext highlighter-rouge">messaging/ui.launchActivity</code></li>
</ul>

<h3 id="scope-examples">Scope examples</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Location: https://ehr/authorize?
  response_type=code&amp;
  client_id=app-client-id&amp;
  redirect_uri=https%3A%2F%2Fapp%2Fafter-auth&amp;
  launch=xyz123&amp;
  scope=+launch+patient%2FMedicationRequest.read+messaging%2Fui.launchActivity+openid+profile&amp;
  state=98wrghuwuogerg97&amp;
  aud=https://ehr/fhir
</code></pre></div></div>

<p>Following the OAuth 2.0 handshake, the authorization server returns the authorized SMART launch parameters alongside the access_token. Note the <code class="language-plaintext highlighter-rouge">scope</code> and <code class="language-plaintext highlighter-rouge">smart_messaging_origin</code> values:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
  "access_token": "i8hweunweunweofiwweoijewiwe",
  "token_type": "bearer",
  "expires_in": 3600,
  "scope": "patient/Observation.read patient/Patient.read messaging/ui.launchActivity",
  "smart_messaging_origin": "https://ehr.example.org",
  "state": "98wrghuwuogerg97",
  "patient":  "123",
  "encounter": "456",
}
</code></pre></div></div>

<h2 id="limitations">Limitations</h2>

<p>Using a <code class="language-plaintext highlighter-rouge">postMessage</code>-based message allows flexible, standards-based integration that works across windows and frames, and should be readily supportable in browser controls for thick-client EHRs.</p>

<p>The use of web messaging requires the app to be a web application, which is either embedded within an iframe or launched from a window.</p>

<p>SMART messaging is not a context synchronization specification (see http://fhircast.org for that). Rather, it’s a collection of functions available to a web app embedded within an EHR which supports tight workflow integration.</p>

<h2 id="alternatives-considered">Alternatives considered</h2>
<p><a name="07480bf6-8b35-426f-a2be-66c7a924dca6">​</a>See <a href="./alternatives-considered.md">alternatives-considered.md</a></p>

<h2 id="open-questions">Open Questions</h2>

<ol>
  <li>Does the app authenticate in the the postMessage body? Should the app pass the access_token in the postmessage to authenticate itself?</li>
</ol>

<ul>
  <li>Currently, we don’t have this in the above, because of the concern around bringing the access_token to the client in javascript, and because the host having launched the app is what authenticates the app.
Should there be something that is exchanged between the app and the host to authenticate the app at all? Or is the host having launched the app enough authorization for the app?</li>
</ul>

<ol>
  <li>
    <p>Does access expire with SMART access_tokens?</p>
  </li>
  <li>How does the app know what messageTypes are supported? 
There are two aspects to this:
    <ul>
      <li>Does the container at all support messaging?</li>
      <li>What messages are supported in this context?</li>
    </ul>
  </li>
  <li>Does (3) above need to be an initial handshake postMessage? Do scopes in access_token already meet this need? Or do we need something like added details in a well-known/smart-configuration.json / documentation?</li>
</ol>


</div>
        </div>    <!-- /inner-wrapper -->
      </div>    <!-- /row -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-content -->

  <script src="assets/js/jquery.js" type="text/javascript"> </script>       <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script src="assets/js/jquery-ui.min.js" type="text/javascript"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <div igtool="footer" id="segment-footer" class="segment">    <!-- segment-footer -->
    <div class="container">    <!-- container -->
      <div class="inner-wrapper">
        <p>
          IG &copy; 2020+ <a style="color: #81BEF7" href="https://argonautwiki.hl7.org">The Argonaut Project</a>.  Package hl7.fhir.smart-web-messaging#1.0.0 based on <a style="color: #81BEF7" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Mon, Jul 6, 2020 23:44-0500">2020-07-06</span>
          <br/>
          <span style="color: #FFFF77">
                      Links: <a style="color: #81BEF7" href="toc.html">Table of Contents</a> |
                 <a style="color: #81BEF7" href="qa.html">QA Report</a>
          </span>
        </p>
      </div>    <!-- /inner-wrapper -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">    <!-- segment-post-footer -->
    <div class="container">    <!-- container -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-post-footer -->
  
    <!-- JS and analytics only. -->
    <!-- Bootstrap core JavaScript
  ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
  <script src="assets/js/bootstrap.min.js" type="text/javascript"> </script>
  <script src="assets/js/respond.min.js" type="text/javascript"> </script>
  <script src="assets/js/anchor.min.js" type="text/javascript"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
    <!-- Analytics Below
  ================================================== -->
  </body>
</html>